<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>User Management</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body>
<div th:replace="~{fragments/admin-navbar :: navbar}"></div>

<div class="container mt-4" sec:authorize="hasAuthority('ROLE_ADMIN')">
    <h2>User Management</h2>

    <!-- ✅ One-time Password Modal -->
    <div th:if="${param.createdWithPassword}" class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-primary">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">User Created</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p><strong>Temporary Password:</strong></p>
                    <div class="input-group">
                        <input type="text" class="form-control" id="generatedPassword" readonly th:value="${param.createdWithPassword}">
                        <button type="button" class="btn btn-outline-secondary" onclick="copyPassword()">Copy</button>
                    </div>
                    <small class="text-muted mt-2 d-block">Please copy this password now. It won’t be shown again.</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Form -->
    <form method="get" class="row g-2 mb-3">
        <div class="col-md-3">
            <input type="text" name="keyword" th:value="${keyword}" class="form-control" placeholder="Search by username"/>
        </div>

        <div class="col-md-2">
            <select name="active" class="form-select" onchange="this.form.submit()">
                <option value="" th:selected="${active == null}">All</option>
                <option value="true" th:selected="${active == true}">Active</option>
                <option value="false" th:selected="${active == false}">Inactive</option>
            </select>
        </div>

        <div class="col-md-2">
            <select name="size" class="form-select" onchange="this.form.submit()">
                <option value="5" th:selected="${pageSize == 5}">5</option>
                <option value="10" th:selected="${pageSize == 10}">10</option>
                <option value="20" th:selected="${pageSize == 20}">20</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-outline-primary w-100">Search</button>
        </div>

        <div class="col-md-3">
            <a th:href="@{/admin/users/create}" class="btn btn-success w-100">➕ Create User</a>
        </div>
    </form>

    <!-- User Table -->
    <table class="table table-bordered table-striped">
        <thead class="table-light">
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="u : ${userPage.content}">
            <td th:text="${u.username}"></td>
            <td th:text="${u.email}"></td>
            <td th:text="${u.role}"></td>
            <td>
                <span th:text="${u.active} ? 'Active' : 'Inactive'"
                      th:classappend="${u.active} ? 'badge bg-success' : 'badge bg-secondary'"></span>
            </td>
            <td>
                <a th:href="@{/admin/users/edit/{id}(id=${u.id})}" class="btn btn-primary btn-sm">Edit</a>
                <a th:if="${u.active}"
                   th:href="@{/admin/users/deactivate/{id}(id=${u.id})}" class="btn btn-warning btn-sm"
                   onclick="return confirm('Deactivate this user?')">Deactivate</a>
                <a th:unless="${u.active}"
                   th:href="@{/admin/users/activate/{id}(id=${u.id})}" class="btn btn-success btn-sm">Activate</a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Pagination -->
    <div th:if="${userPage.totalPages > 1}">
        <ul class="pagination pagination-sm">
            <li class="page-item" th:classappend="${userPage.first} ? 'disabled'">
                <a class="page-link"
                   th:href="@{|/admin/users?page=${userPage.number - 1}&size=${pageSize}&active=${active}|}">Previous</a>
            </li>
            <li class="page-item disabled">
                <span class="page-link">
                    Page <span th:text="${userPage.number + 1}"></span> /
                    <span th:text="${userPage.totalPages}"></span>
                </span>
            </li>
            <li class="page-item" th:classappend="${userPage.last} ? 'disabled'">
                <a class="page-link"
                   th:href="@{|/admin/users?page=${userPage.number + 1}&size=${pageSize}&active=${active}|}">Next</a>
            </li>
        </ul>
    </div>
</div>

<!-- Fallback for unauthorized -->
<div class="container mt-4" sec:authorize="!hasAuthority('ROLE_ADMIN')">
    <div class="alert alert-warning">You do not have permission to view this page.</div>
</div>

<!-- Bootstrap & Modal Script -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script th:if="${param.createdWithPassword}">
    window.addEventListener("DOMContentLoaded", function () {
        const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
        modal.show();
    });
</script>
<script>
    function copyPassword() {
        const input = document.getElementById('generatedPassword');
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value)
            .then(() => alert("Password copied to clipboard!"))
            .catch(() => alert("Failed to copy password."));
    }
</script>
</body>
</html>
